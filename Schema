generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum AuthType {
  LINE
  GOOGLE
  APPLE
  EMAIL
}

enum ActivityType {
  INCOME
  EXPENSE
  PLANTING
  GENERAL
}

enum CropCycleStatus {
  ACTIVE
  COMPLETED
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  STAFF
}

enum AuditActorType {
  USER
  ADMIN
  SYSTEM
}

enum PlotStatus {
  NORMAL
  INACTIVE
  ARCHIVED
}

enum FarmRole {
  OWNER
  EDITOR
  VIEWER
}

// ===== PLOT ENUMS =====
enum SoilType {
  CLAY        // ดินเหนียว
  LOAM        // ดินร่วน
  SAND        // ดินทราย
  SILT        // ดินตะกอน
  PEAT        // ดินพรุ
}

enum WaterSource {
  WELL        // บ่อบาดาล
  RIVER       // แม่น้ำ/ลำคลอง
  RAIN        // น้ำฝน
  POND        // บ่อเก็บน้ำ
  TAP         // ประปา
}

enum IrrigationType {
  DRIP        // น้ำหยด
  SPRINKLER   // สปริงเกอร์
  FLOOD       // ท่วมขัง
  FURROW      // ร่อง
  MANUAL      // รดด้วยมือ
}

enum SunExposure {
  FULL        // แดดจัด
  PARTIAL     // ร่มรำไร
  SHADE       // ร่มเงา
}

// ===== AI/RECOMMENDATION ENUMS =====
enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AiRecommendationType {
  CROP_PLAN       // แผนปลูก
  ACTIVITY        // กิจกรรม
  PRODUCT         // สินค้า/วัสดุ
  DISEASE         // โรคพืช
  GENERAL         // ทั่วไป
}

// ===== STOCK/INVENTORY ENUMS =====
enum StockMovementReason {
  ACTIVITY        // ใช้ในกิจกรรม
  PURCHASE        // ซื้อเข้า
  ADJUST          // ปรับปรุง
  DAMAGE          // เสียหาย/หมดอายุ
  TRANSFER        // โอนย้าย
}

// ===== BACKGROUND JOB ENUMS =====
enum JobType {
  DELETE_PLOT
  DELETE_USER
  CLEANUP_ARCHIVE
  REBUILD_CACHE
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

//////////////////////////////////////////////////////
// USER & AUTH
//////////////////////////////////////////////////////

model User {
  id          String @id @default(cuid())

  displayName String?
  firstName   String?
  lastName    String?
  pictureUrl  String?
  address     String?
  
  // LINE Integration
  lineUserId  String? @unique

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  providers   AuthProvider[]
  settings    UserSetting?
  plots       Plot[]
  activities  Activity[]
  aiLogs      AiActivityLog[]
  farmMembers FarmMember[]
  notificationTargets NotificationTarget[]
  notificationReads NotificationRead[]
  mediaFiles  MediaFile[]
  aiRecommendations AiRecommendation[]
  
  // สินค้า/วัสดุ ของผู้ใช้ (Inventory)
  userProducts UserProduct[]

  @@index([createdAt])
}

model AuthProvider {
  id          String   @id @default(cuid())

  provider    AuthType
  providerUid String
  email       String?

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([provider, providerUid])
  @@index([userId])
}

model UserSetting {
  id        String @id @default(cuid())

  userId    String @unique
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  language  String @default("th")
  timezone  String @default("Asia/Bangkok")
  unit      String @default("METRIC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////////
// ADMIN
//////////////////////////////////////////////////////

model Admin {
  id          String    @id @default(cuid())
  username    String    @unique
  email       String?   @unique
  password    String
  name        String?
  role        AdminRole @default(ADMIN)
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?

  notifications SystemNotification[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

//////////////////////////////////////////////////////
// FARM STRUCTURE
//////////////////////////////////////////////////////

model Plot {
  id        String @id @default(cuid())
  name      String
  size      Float

  status    PlotStatus @default(NORMAL)
  image     String?
  lat       Float?
  lng       Float?
  address   String?
  
  // GeoJSON polygon for boundary
  polygon     Json? @db.JsonB
  
  // Soil & Environment (AI uses these)
  soilType    SoilType?
  waterSource WaterSource?
  elevation   Float?     // meters above sea level
  slope       Float?     // % slope
  irrigation  IrrigationType?
  sunExposure SunExposure?
  
  // AI Analysis
  lastAiAnalyzedAt DateTime?

  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  cropCycles       CropCycle[]
  activities       Activity[]
  members          FarmMember[]
  weatherSnapshots WeatherSnapshot[]
  soilSnapshots    SoilSnapshot[]
  summary          PlotSummary?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@index([userId])
  @@index([status])
}


model FarmMember {
  id        String @id @default(cuid())

  plotId    String
  plot      Plot   @relation(fields: [plotId], references: [id], onDelete: Cascade)

  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  role      FarmRole

  createdAt DateTime @default(now())

  @@unique([plotId, userId])
  @@index([userId])
}

model CropCycle {
  id        String @id @default(cuid())

  plotId    String
  plot      Plot   @relation(fields: [plotId], references: [id], onDelete: Cascade)

  cropType  String?

  cropVarietyId String?
  cropVariety   CropVariety? @relation(fields: [cropVarietyId], references: [id])

  startDate DateTime @default(now())
  endDate   DateTime?

  status    CropCycleStatus @default(ACTIVE)
  yield     Decimal? @db.Decimal(10,2)
  note      String?

  planId    String?
  plan      CropPlan? @relation(fields: [planId], references: [id])

  activities Activity[]
  aiRecommendations AiRecommendation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@index([plotId, status])
  @@index([startDate])
}

//////////////////////////////////////////////////////
// MASTER DATA – CROP
//////////////////////////////////////////////////////

model CropType {
  id        String @id @default(cuid())
  name      String @unique

  varieties CropVariety[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CropVariety {
  id          String @id @default(cuid())
  name        String
  duration    Int?

  cropTypeId  String
  cropType    CropType @relation(fields: [cropTypeId], references: [id])

  cropCycles  CropCycle[]
  plans       CropPlan[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

//////////////////////////////////////////////////////
// MASTER DATA – PRODUCT
//////////////////////////////////////////////////////

model ProductCategory {
  id        String @id @default(cuid())
  name      String @unique

  types     ProductType[]
  products  Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductType {
  id          String @id @default(cuid())
  name        String

  categoryId  String
  category    ProductCategory @relation(fields: [categoryId], references: [id])

  products    Product[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProductBrand {
  id        String @id @default(cuid())
  name      String @unique

  products  Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          String @id @default(cuid())
  name        String

  categoryId  String?
  category    ProductCategory? @relation(fields: [categoryId], references: [id])

  typeId      String?
  type        ProductType? @relation(fields: [typeId], references: [id])

  brandId     String?
  brand       ProductBrand? @relation(fields: [brandId], references: [id])

  price       Decimal? @db.Decimal(12,2)
  description String?
  imageUrl    String?
  unit        String?                 // หน่วย (กก., ลิตร, ถุง)
  
  // สถานะ
  isActive    Boolean  @default(true) // เปิด/ปิดการแสดงผล
  isSponsored Boolean  @default(false) // มี sponsor หรือไม่
  
  activities  Activity[]
  
  // Relations สำหรับ Inventory และ Ads
  userProducts   UserProduct[]       // inventory ของผู้ใช้ที่อ้าง product นี้
  promotions     ProductPromotion[]  // โปรโมชัน/sponsor
  impressions    ProductImpression[] // การแสดงผล (analytics)
  clicks         ProductClick[]      // การคลิก (analytics)
  rankCache      ProductRankCache?   // cache ranking สำหรับ AI/Ads

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive])
  @@index([brandId])
}

//////////////////////////////////////////////////////
// ACTIVITY CATEGORY
//////////////////////////////////////////////////////

model ActivityCategory {
  id        String @id @default(cuid())
  name      String
  type      ActivityType

  activities Activity[]

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////////
// CROP PLAN
//////////////////////////////////////////////////////

model CropPlan {
  id          String @id @default(cuid())
  name        String
  description String?

  varieties   CropVariety[]
  stages      PlanStage[]
  cropCycles  CropCycle[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PlanStage {
  id          String @id @default(cuid())

  planId      String
  plan        CropPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  stageName   String
  dayStart    Int
  dayEnd      Int?

  action      String
  method      String
  reason      String

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

//////////////////////////////////////////////////////
// ACTIVITY & MEDIA
//////////////////////////////////////////////////////

model Activity {
  id          String @id @default(cuid())

  type        ActivityType
  amount      Decimal? @db.Decimal(12,2)
  description String?
  date        DateTime @default(now())

  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId  String?
  category    ActivityCategory? @relation(fields: [categoryId], references: [id])

  plotId      String?
  plot        Plot?  @relation(fields: [plotId], references: [id])

  cropCycleId String?
  cropCycle   CropCycle? @relation(fields: [cropCycleId], references: [id])

  productId   String?
  product     Product? @relation(fields: [productId], references: [id])

  quantity    Float?
  unit        String?
  unitPrice   Decimal? @db.Decimal(12,2)

  images      ActivityImage[]

  createdAt   DateTime @default(now())
  deletedAt   DateTime?

  @@index([userId, date])
  @@index([plotId, date])
  @@index([cropCycleId, date])
  @@index([type, date])
  @@index([userId, type, date])
}

model ActivityImage {
  id         String   @id @default(cuid())
  activityId String
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  imageUrl   String
  createdAt  DateTime @default(now())

  @@index([activityId])
}

//////////////////////////////////////////////////////
// AI & AUDIT
//////////////////////////////////////////////////////

model AiActivityLog {
  id         String   @id @default(cuid())

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  rawInput   String
  parsedData Json
  confidence Float?   @db.Real
  success    Boolean

  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([success])
}

model AuditLog {
  id        String @id @default(cuid())

  actorType AuditActorType
  actorId   String?

  action    String
  target    String
  targetId  String?

  data      Json?
  ip        String?

  createdAt DateTime @default(now())

  @@index([actorType, createdAt])
  @@index([target, targetId])
  @@index([createdAt])
}

model SystemSettings {
  id        String   @id @default("system")

  // ===== BRANDING =====
  siteName  String   @default("Smart Farm")
  siteDescription String?
  logoUrl   String?
  faviconUrl String?

  // ===== CONTACT =====
  supportEmail String?
  supportPhone String?

  // ===== LOCALIZATION =====
  defaultLanguage String @default("th")
  timezone String @default("Asia/Bangkok")

  // ===== SYSTEM STATE =====
  maintenanceMode Boolean @default(false)
  maintenanceMessage String?

  // ===== AI CONFIG =====
  enableAI Boolean @default(true)
  aiMode String @default("ASSIST") // ASSIST, AUTO, DISABLED

  maxAIRequestsPerUserPerDay Int @default(10)
  maxAIRequestsSystemPerDay Int @default(10000)

  aiMinConfidence Float @default(0.7)

  aiRecommendCropPlan Boolean @default(true)
  aiRecommendActivity Boolean @default(true)
  aiRecommendProduct Boolean @default(true)
  aiRecommendDisease Boolean @default(true)

  aiRequireUserConfirmation Boolean @default(true)
  aiPromptVersion String @default("v1")
  aiExperimentGroup String?
  
  // AI Provider Settings
  aiProvider String @default("mock")  // openai, gemini, claude, groq, mock
  aiModel String @default("mock-v1")
  aiCostLimitUsdPerDay Decimal? @db.Decimal(10,2) // จำกัดค่าใช้จ่าย AI ต่อวัน (USD)
  
  // ===== PRODUCT SPONSOR POLICY =====
  maxSponsoredRatio Float @default(0.3)       // โควต้าสินค้า sponsor สูงสุด (30%)
  sponsoredLabelText String @default("โฆษณา") // ข้อความแสดงบน UI

  // ===== SOCIAL LOGIN CONFIG =====
  // LINE
  lineClientId String?
  lineClientSecret String?
  lineEnabled Boolean @default(false)

  // Google
  googleClientId String?
  googleClientSecret String?
  googleEnabled Boolean @default(false)

  // Facebook
  facebookAppId String?
  facebookAppSecret String?
  facebookEnabled Boolean @default(false)

  // ===== NOTIFICATIONS =====
  enableNotifications Boolean @default(true)
  enableEmailNotifications Boolean @default(true)
  enablePushNotifications Boolean @default(true)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

// ===== SYSTEM NOTIFICATION (Admin ส่งแจ้งเตือน) =====
model SystemNotification {
  id              String   @id @default(uuid())
  title           String
  message         String
  type            String   @default("INFO") // INFO, WARNING, SUCCESS, ERROR
  target          String   @default("ALL") // ALL, SPECIFIC
  sentById        String?
  sentBy          Admin?   @relation(fields: [sentById], references: [id])
  totalSent       Int      @default(0)
  
  targets         NotificationTarget[]
  reads           NotificationRead[]
  
  createdAt       DateTime @default(now())

  @@index([createdAt])
  @@index([type])
}

model NotificationTarget {
  id              String @id @default(uuid())
  notificationId  String
  notification    SystemNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  userId          String
  user            User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([notificationId, userId])
  @@index([userId])
}

model NotificationRead {
  id              String   @id @default(uuid())
  notificationId  String
  notification    SystemNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  readAt          DateTime @default(now())

  @@unique([notificationId, userId])
  @@index([userId])
}

// ===== MEDIA FILE =====
model MediaFile {
  id            String   @id @default(uuid())
  filename      String
  originalName  String
  mimetype      String
  size          Int
  url           String
  uploadedById  String?
  uploadedBy    User?    @relation(fields: [uploadedById], references: [id])
  
  // Storage metadata
  provider      String?  // aws, r2, cloudflare, local
  bucket        String?
  checksum      String?
  
  createdAt     DateTime @default(now())

  @@index([uploadedById])
  @@index([createdAt])
}

// ===== WEATHER SNAPSHOT =====
model WeatherSnapshot {
  id        String   @id @default(uuid())
  plotId    String
  plot      Plot     @relation(fields: [plotId], references: [id], onDelete: Cascade)
  date      DateTime
  rainMm    Float?
  tempMin   Float?
  tempMax   Float?
  humidity  Float?
  windSpeed Float?
  source    String   // openweather, station, manual
  createdAt DateTime @default(now())
  deletedAt DateTime?

  @@unique([plotId, date])
  @@index([plotId])
  @@index([date])
}

// ===== SOIL SNAPSHOT =====
model SoilSnapshot {
  id         String   @id @default(uuid())
  plotId     String
  plot       Plot     @relation(fields: [plotId], references: [id], onDelete: Cascade)
  moisture   Float?   // %
  ph         Float?   // 0-14
  nitrogen   Float?   // ppm
  phosphorus Float?   // ppm
  potassium  Float?   // ppm
  recordedAt DateTime
  source     String?  // sensor, manual
  createdAt  DateTime @default(now())
  deletedAt  DateTime?

  @@index([plotId, recordedAt])
}

// ===== AI RECOMMENDATION =====
model AiRecommendation {
  id          String   @id @default(uuid())
  
  plotId      String?
  cropCycleId String?
  cropCycle   CropCycle? @relation(fields: [cropCycleId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String   // CROP_PLAN, ACTIVITY, ALERT, WEATHER
  title       String
  suggestion  String   @db.Text
  reasoning   String?  @db.Text
  confidence  Float    @db.Real
  priority    String?  // LOW, MEDIUM, HIGH, CRITICAL
  accepted    Boolean?
  feedback    String?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  deletedAt   DateTime?

  @@index([userId, createdAt])
  @@index([type])
  @@index([plotId])
  @@index([cropCycleId])
}

// ===== PLOT SUMMARY (Cache for Performance) =====
model PlotSummary {
  plotId         String   @id
  plot           Plot     @relation(fields: [plotId], references: [id], onDelete: Cascade)
  totalIncome    Decimal? @db.Decimal(12,2)
  totalExpense   Decimal? @db.Decimal(12,2)
  profit         Decimal? @db.Decimal(12,2)
  totalActivities Int?
  lastActivityAt DateTime?
  updatedAt      DateTime @updatedAt
}

// ===== FEATURE FLAG =====
model FeatureFlag {
  key       String   @id
  enabled   Boolean  @default(false)
  rollout   Int?     // % rollout (0-100)
  metadata  Json?    @db.JsonB
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////////
// USER PRODUCT (INVENTORY) - สินค้า/วัสดุ ของผู้ใช้
//////////////////////////////////////////////////////

model UserProduct {
  id           String   @id @default(cuid())

  // เจ้าของ
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // อ้างอิง Product จาก Catalog (optional - ถ้าเลือกจาก catalog)
  productId    String?
  product      Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  // ข้อมูลสินค้า
  name         String              // ชื่อสินค้า (custom ได้)
  category     String              // หมวดหมู่: ปุ๋ย, ยา, เมล็ด, วัสดุ
  type         String?             // ประเภทย่อย: ปุ๋ยเคมี, ปุ๋ยอินทรีย์, ยาฆ่าแมลง
  
  // จำนวน/สต็อก
  quantity     Float   @default(0)  // จำนวนที่มี
  unit         String?              // หน่วย: กก., ลิตร, ถุง, ขวด
  
  // รายละเอียด
  brand        String?              // แบรนด์ (ถ้ารู้)
  note         String?              // หมายเหตุ
  price        Decimal? @db.Decimal(12,2) // ราคาซื้อ

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  movements    UserProductMovement[] // ประวัติการเพิ่ม/ลด สต็อก

  @@index([userId])
  @@index([productId])
  @@index([category])
}

//////////////////////////////////////////////////////
// PRODUCT PROMOTION - โฆษณา/Sponsor
//////////////////////////////////////////////////////

model ProductPromotion {
  id              String    @id @default(uuid())
  
  // สินค้าที่โปรโมท
  productId       String
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // ข้อมูล Sponsor
  sponsorName     String?   // ชื่อบริษัท/แบรนด์
  campaignName    String?   // ชื่อแคมเปญ
  
  // ราคา/Bidding
  bidAmount       Decimal   @db.Decimal(12,2)  // เงินที่จ่าย
  priority        Int?      // manual override โดย admin
  
  // ระยะเวลา
  startAt         DateTime
  endAt           DateTime
  
  // Targeting (optional)
  targetCropTypeId String?  // เจาะจงประเภทพืช
  targetPlotId     String?  // เจาะจงแปลง
  targetRegion     String?  // เจาะจงภูมิภาค
  
  // AI Boost
  aiBoostFactor   Float     @default(1.0) // ตัวคูณคะแนน AI (1.0 = ปกติ, 2.0 = x2)
  
  // สถานะ
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  
  @@index([isActive, startAt, endAt])
  @@index([productId])
}

//////////////////////////////////////////////////////
// PRODUCT ANALYTICS - การติดตามการแสดงผล/คลิก
//////////////////////////////////////////////////////

// การแสดงผล (Impression) - สำหรับคำนวณ CPM
model ProductImpression {
  id          String   @id @default(uuid())
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  userId      String?  // ใครเห็น
  plotId      String?  // เห็นในแปลงไหน
  source      String   // AI, SEARCH, BANNER, RECOMMENDATION
  
  createdAt   DateTime @default(now())
  
  @@index([productId])
  @@index([createdAt])
  @@index([source])
}

// การคลิก (Click) - สำหรับคำนวณ CTR
model ProductClick {
  id          String   @id @default(uuid())
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  userId      String?  // ใครคลิก
  source      String?  // คลิกจากไหน
  
  createdAt   DateTime @default(now())
  
  @@index([productId])
  @@index([createdAt])
}

//////////////////////////////////////////////////////
// STOCK MOVEMENT - ประวัติการเพิ่ม/ลด สต็อก
//////////////////////////////////////////////////////

model UserProductMovement {
  id              String   @id @default(uuid())
  
  userProductId   String
  userProduct     UserProduct @relation(fields: [userProductId], references: [id], onDelete: Cascade)
  
  change          Float              // + เพิ่ม / - ลด
  reason          StockMovementReason // สาเหตุ
  note            String?            // หมายเหตุ
  
  refActivityId   String?            // อ้างอิงกิจกรรม (optional)
  
  createdAt       DateTime @default(now())
  
  @@index([userProductId])
  @@index([createdAt])
}

//////////////////////////////////////////////////////
// PRODUCT RANK CACHE - สำหรับ AI/Ads Performance
//////////////////////////////////////////////////////

model ProductRankCache {
  productId   String   @id
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  score       Float    @default(0)    // คะแนนรวม (AI + boost + bid)
  impressions Int      @default(0)    // จำนวน views
  clicks      Int      @default(0)    // จำนวน clicks
  ctr         Float    @default(0)    // Click-through rate
  
  updatedAt   DateTime @updatedAt
  
  @@index([score(sort: Desc)])
}

//////////////////////////////////////////////////////
// AI REQUEST LOG - ติดตาม Cost / Usage
//////////////////////////////////////////////////////

model AiRequestLog {
  id          String   @id @default(uuid())
  
  provider    String              // openai, gemini, claude, groq
  model       String              // gpt-4, gemini-pro
  
  userId      String?             // user ที่ request (optional)
  
  inputTokens   Int?              // tokens ที่ส่งไป
  outputTokens  Int?              // tokens ที่ได้กลับ
  totalTokens   Int?              // รวม
  costUsd       Decimal? @db.Decimal(10,6) // ค่าใช้จ่าย (USD)
  
  latencyMs     Int?              // เวลาตอบสนอง (ms)
  success       Boolean @default(true)
  error         String?           // error message ถ้ามี
  
  createdAt   DateTime @default(now())
  
  @@index([provider])
  @@index([createdAt])
  @@index([userId])
}

//////////////////////////////////////////////////////
// BACKGROUND JOB SYSTEM
//////////////////////////////////////////////////////

model BackgroundJob {
  id          String    @id @default(uuid())

  type        JobType
  status      JobStatus @default(PENDING)

  // ใครเป็นคน trigger (optional)
  triggeredByUserId  String?
  triggeredByAdminId String?

  // payload สำหรับ job
  payload     Json      @db.JsonB

  // retry
  retryCount  Int       @default(0)
  maxRetry    Int       @default(3)

  // error
  lastError   String?
  lastErrorAt DateTime?

  // timing
  startedAt   DateTime?
  finishedAt  DateTime?
  
  // Worker lock (ป้องกัน 2 workers หยิบ job เดียวกัน)
  lockedAt    DateTime?
  lockedBy    String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  progress    JobProgress[]
  logs        JobLog[]

  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model JobProgress {
  id         String   @id @default(uuid())

  jobId      String
  job        BackgroundJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  entity     String   // activity, crop_cycle, snapshot
  processed  Int      @default(0)
  total      Int?
  lastCursor String?  // สำหรับ resume batch

  updatedAt  DateTime @updatedAt

  @@unique([jobId, entity])
}

model JobLog {
  id        String   @id @default(uuid())

  jobId     String
  job       BackgroundJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  level     String   // INFO, WARN, ERROR
  message   String
  data      Json?    @db.JsonB

  createdAt DateTime @default(now())

  @@index([jobId])
  @@index([createdAt])
}
